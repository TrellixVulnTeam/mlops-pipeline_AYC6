{
   "Version":"2020-12-01",
   "Metadata":{
      
   },
   "Parameters":[
      {
         "Name":"ProcessingInstanceCount",
         "Type":"Integer",
         "DefaultValue":1
      },
      {
         "Name":"TrainingInstanceType",
         "Type":"String",
         "DefaultValue":"ml.m5.xlarge"
      },
      {
         "Name":"InputDataUrl",
         "Type":"String",
         "DefaultValue":"s3://sagemaker-sample-files/datasets/tabular/uci_abalone/abalone.csv"
      },
      {
         "Name":"BatchData",
         "Type":"String",
         "DefaultValue":"s3://sagemaker-us-east-1-368703438116/abalone/abalone-dataset-batch"
      },
      {
         "Name":"ModelApprovalStatus",
         "Type":"String",
         "DefaultValue":"PendingManualApproval"
      }
   ],
   "PipelineExperimentConfig":{
      "ExperimentName":{
         "Get":"Execution.PipelineName"
      },
      "TrialName":{
         "Get":"Execution.PipelineExecutionId"
      }
   },
   "Steps":[
      {
         "Name":"PreprocessAbaloneDataForHPO",
         "Type":"Processing",
         "Arguments":{
            "ProcessingResources":{
               "ClusterConfig":{
                  "InstanceType":"ml.m5.xlarge",
                  "InstanceCount":{
                     "Get":"Parameters.ProcessingInstanceCount"
                  },
                  "VolumeSizeInGB":30
               }
            },
            "AppSpecification":{
               "ImageUri":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:0.23-1-cpu-py3",
               "ContainerArguments":[
                  "--input-data",
                  {
                     "Get":"Parameters.InputDataUrl"
                  }
               ],
               "ContainerEntrypoint":[
                  "python3",
                  "/opt/ml/processing/input/code/preprocess.py"
               ]
            },
            "RoleArn":"arn:aws:iam::368703438116:role/service-role/AmazonSageMaker-ExecutionRole-20220726T101201",
            "ProcessingInputs":[
               {
                  "InputName":"code",
                  "AppManaged":false,
                  "S3Input":{
                     "S3Uri":"s3://sagemaker-us-east-1-368703438116/tuning-step-example/sklearn-abalone-pre-2022-08-01-04-14-50-310/input/code/preprocess.py",
                     "LocalPath":"/opt/ml/processing/input/code",
                     "S3DataType":"S3Prefix",
                     "S3InputMode":"File",
                     "S3DataDistributionType":"FullyReplicated",
                     "S3CompressionType":"None"
                  }
               }
            ],
            "ProcessingOutputConfig":{
               "Outputs":[
                  {
                     "OutputName":"train",
                     "AppManaged":false,
                     "S3Output":{
                        "S3Uri":{
                           "Std:Join":{
                              "On":"/",
                              "Values":[
                                 "s3:/",
                                 "sagemaker-us-east-1-368703438116",
                                 "tuning-step-example",
                                 {
                                    "Get":"Execution.PipelineExecutionId"
                                 },
                                 "PreprocessAbaloneDataForHPO"
                              ]
                           }
                        },
                        "LocalPath":"/opt/ml/processing/train",
                        "S3UploadMode":"EndOfJob"
                     }
                  },
                  {
                     "OutputName":"validation",
                     "AppManaged":false,
                     "S3Output":{
                        "S3Uri":{
                           "Std:Join":{
                              "On":"/",
                              "Values":[
                                 "s3:/",
                                 "sagemaker-us-east-1-368703438116",
                                 "tuning-step-example",
                                 {
                                    "Get":"Execution.PipelineExecutionId"
                                 },
                                 "PreprocessAbaloneDataForHPO"
                              ]
                           }
                        },
                        "LocalPath":"/opt/ml/processing/validation",
                        "S3UploadMode":"EndOfJob"
                     }
                  },
                  {
                     "OutputName":"test",
                     "AppManaged":false,
                     "S3Output":{
                        "S3Uri":{
                           "Std:Join":{
                              "On":"/",
                              "Values":[
                                 "s3:/",
                                 "sagemaker-us-east-1-368703438116",
                                 "tuning-step-example",
                                 {
                                    "Get":"Execution.PipelineExecutionId"
                                 },
                                 "PreprocessAbaloneDataForHPO"
                              ]
                           }
                        },
                        "LocalPath":"/opt/ml/processing/test",
                        "S3UploadMode":"EndOfJob"
                     }
                  }
               ]
            }
         }
      },
      {
         "Name":"HPTuning",
         "Type":"Tuning",
         "Arguments":{
            "HyperParameterTuningJobConfig":{
               "Strategy":"Random",
               "ResourceLimits":{
                  "MaxNumberOfTrainingJobs":3,
                  "MaxParallelTrainingJobs":3
               },
               "TrainingJobEarlyStoppingType":"Off",
               "HyperParameterTuningJobObjective":{
                  "Type":"Minimize",
                  "MetricName":"validation:rmse"
               },
               "ParameterRanges":{
                  "ContinuousParameterRanges":[
                     {
                        "Name":"alpha",
                        "MinValue":"0.01",
                        "MaxValue":"10",
                        "ScalingType":"Logarithmic"
                     },
                     {
                        "Name":"lambda",
                        "MinValue":"0.01",
                        "MaxValue":"10",
                        "ScalingType":"Logarithmic"
                     }
                  ],
                  "CategoricalParameterRanges":[
                     
                  ],
                  "IntegerParameterRanges":[
                     
                  ]
               }
            },
            "TrainingJobDefinition":{
               "StaticHyperParameters":{
                  "eval_metric":"rmse",
                  "objective":"reg:squarederror",
                  "num_round":"50",
                  "max_depth":"5",
                  "eta":"0.2",
                  "gamma":"4",
                  "min_child_weight":"6",
                  "subsample":"0.7",
                  "silent":"0"
               },
               "RoleArn":"arn:aws:iam::368703438116:role/service-role/AmazonSageMaker-ExecutionRole-20220726T101201",
               "OutputDataConfig":{
                  "S3OutputPath":"s3://sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTrain"
               },
               "ResourceConfig":{
                  "VolumeSizeInGB":30,
                  "InstanceCount":1,
                  "InstanceType":{
                     "Get":"Parameters.TrainingInstanceType"
                  }
               },
               "StoppingCondition":{
                  "MaxRuntimeInSeconds":86400
               },
               "AlgorithmSpecification":{
                  "TrainingInputMode":"File",
                  "TrainingImage":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.0-1-cpu-py3"
               },
               "InputDataConfig":[
                  {
                     "DataSource":{
                        "S3DataSource":{
                           "S3DataType":"S3Prefix",
                           "S3Uri":{
                              "Get":"Steps.PreprocessAbaloneDataForHPO.ProcessingOutputConfig.Outputs['train'].S3Output.S3Uri"
                           },
                           "S3DataDistributionType":"FullyReplicated"
                        }
                     },
                     "ContentType":"text/csv",
                     "ChannelName":"train"
                  },
                  {
                     "DataSource":{
                        "S3DataSource":{
                           "S3DataType":"S3Prefix",
                           "S3Uri":{
                              "Get":"Steps.PreprocessAbaloneDataForHPO.ProcessingOutputConfig.Outputs['validation'].S3Output.S3Uri"
                           },
                           "S3DataDistributionType":"FullyReplicated"
                        }
                     },
                     "ContentType":"text/csv",
                     "ChannelName":"validation"
                  }
               ]
            }
         },
         "CacheConfig":{
            "Enabled":true,
            "ExpireAfter":"30d"
         }
      },
      {
         "Name":"EvaluateTopModel",
         "Type":"Processing",
         "Arguments":{
            "ProcessingResources":{
               "ClusterConfig":{
                  "InstanceType":"ml.m5.xlarge",
                  "InstanceCount":1,
                  "VolumeSizeInGB":30
               }
            },
            "AppSpecification":{
               "ImageUri":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.0-1-cpu-py3",
               "ContainerEntrypoint":[
                  "python3",
                  "/opt/ml/processing/input/code/evaluate.py"
               ]
            },
            "RoleArn":"arn:aws:iam::368703438116:role/service-role/AmazonSageMaker-ExecutionRole-20220726T101201",
            "ProcessingInputs":[
               {
                  "InputName":"input-1",
                  "AppManaged":false,
                  "S3Input":{
                     "S3Uri":{
                        "Std:Join":{
                           "On":"/",
                           "Values":[
                              "s3:/",
                              "sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTrain",
                              {
                                 "Get":"Steps.HPTuning.TrainingJobSummaries[0].TrainingJobName"
                              },
                              "output/model.tar.gz"
                           ]
                        }
                     },
                     "LocalPath":"/opt/ml/processing/model",
                     "S3DataType":"S3Prefix",
                     "S3InputMode":"File",
                     "S3DataDistributionType":"FullyReplicated",
                     "S3CompressionType":"None"
                  }
               },
               {
                  "InputName":"input-2",
                  "AppManaged":false,
                  "S3Input":{
                     "S3Uri":{
                        "Get":"Steps.PreprocessAbaloneDataForHPO.ProcessingOutputConfig.Outputs['test'].S3Output.S3Uri"
                     },
                     "LocalPath":"/opt/ml/processing/test",
                     "S3DataType":"S3Prefix",
                     "S3InputMode":"File",
                     "S3DataDistributionType":"FullyReplicated",
                     "S3CompressionType":"None"
                  }
               },
               {
                  "InputName":"code",
                  "AppManaged":false,
                  "S3Input":{
                     "S3Uri":"s3://sagemaker-us-east-1-368703438116/tuning-step-example/script-tuning-step--2022-08-01-04-20-58-217/input/code/evaluate.py",
                     "LocalPath":"/opt/ml/processing/input/code",
                     "S3DataType":"S3Prefix",
                     "S3InputMode":"File",
                     "S3DataDistributionType":"FullyReplicated",
                     "S3CompressionType":"None"
                  }
               }
            ],
            "ProcessingOutputConfig":{
               "Outputs":[
                  {
                     "OutputName":"evaluation",
                     "AppManaged":false,
                     "S3Output":{
                        "S3Uri":"s3://sagemaker-us-east-1-368703438116/tuning-step-example/script-tuning-step--2022-08-01-04-20-58-217/output/evaluation",
                        "LocalPath":"/opt/ml/processing/evaluation",
                        "S3UploadMode":"EndOfJob"
                     }
                  }
               ]
            }
         },
         "CacheConfig":{
            "Enabled":true,
            "ExpireAfter":"30d"
         },
         "PropertyFiles":[
            {
               "PropertyFileName":"BestTuningModelEvaluationReport",
               "OutputName":"evaluation",
               "FilePath":"evaluation.json"
            }
         ]
      },
      {
         "Name":"CheckMSEAbaloneEvaluation",
         "Type":"Condition",
         "Arguments":{
            "Conditions":[
               {
                  "Type":"LessThanOrEqualTo",
                  "LeftValue":{
                     "Std:JsonGet":{
                        "PropertyFile":{
                           "Get":"Steps.EvaluateTopModel.PropertyFiles.BestTuningModelEvaluationReport"
                        },
                        "Path":"regression_metrics.mse.value"
                     }
                  },
                  "RightValue":6.0
               }
            ],
            "IfSteps":[
               {
                  "Name":"CreateBestModel-CreateModel",
                  "Type":"Model",
                  "Arguments":{
                     "ExecutionRoleArn":"arn:aws:iam::368703438116:role/service-role/AmazonSageMaker-ExecutionRole-20220726T101201",
                     "PrimaryContainer":{
                        "Image":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.0-1-cpu-py3",
                        "Environment":{
                           
                        },
                        "ModelDataUrl":{
                           "Std:Join":{
                              "On":"/",
                              "Values":[
                                 "s3:/",
                                 "sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTrain",
                                 {
                                    "Get":"Steps.HPTuning.TrainingJobSummaries[0].TrainingJobName"
                                 },
                                 "output/model.tar.gz"
                              ]
                           }
                        }
                     }
                  }
               },
               {
                  "Name":"CreateSecondBestModel-CreateModel",
                  "Type":"Model",
                  "Arguments":{
                     "ExecutionRoleArn":"arn:aws:iam::368703438116:role/service-role/AmazonSageMaker-ExecutionRole-20220726T101201",
                     "PrimaryContainer":{
                        "Image":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.0-1-cpu-py3",
                        "Environment":{
                           
                        },
                        "ModelDataUrl":{
                           "Std:Join":{
                              "On":"/",
                              "Values":[
                                 "s3:/",
                                 "sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTrain",
                                 {
                                    "Get":"Steps.HPTuning.TrainingJobSummaries[1].TrainingJobName"
                                 },
                                 "output/model.tar.gz"
                              ]
                           }
                        }
                     }
                  }
               },
               {
                  "Name":"RegisterBestAbaloneModel-RegisterModel",
                  "Type":"RegisterModel",
                  "Arguments":{
                     "ModelPackageGroupName":"tuning-job-model-packages",
                     "InferenceSpecification":{
                        "Containers":[
                           {
                              "Image":"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-xgboost:1.0-1-cpu-py3",
                              "Environment":{
                                 
                              },
                              "ModelDataUrl":{
                                 "Std:Join":{
                                    "On":"/",
                                    "Values":[
                                       "s3:/",
                                       "sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTrain",
                                       {
                                          "Get":"Steps.HPTuning.TrainingJobSummaries[0].TrainingJobName"
                                       },
                                       "output/model.tar.gz"
                                    ]
                                 }
                              }
                           }
                        ],
                        "SupportedContentTypes":[
                           "text/csv"
                        ],
                        "SupportedResponseMIMETypes":[
                           "text/csv"
                        ],
                        "SupportedRealtimeInferenceInstanceTypes":[
                           "ml.t2.medium",
                           "ml.m5.large"
                        ],
                        "SupportedTransformInstanceTypes":[
                           "ml.m5.large"
                        ]
                     },
                     "ModelApprovalStatus":{
                        "Get":"Parameters.ModelApprovalStatus"
                     }
                  }
               },
               {
                  "Name":"LambdaStep",
                  "Type":"Lambda",
                  "Arguments":{
                     "model_name":{
                        "Get":"Steps.CreateBestModel-CreateModel.ModelName"
                     },
                     "endpoint_config_name":"demo-lambda-deploy-endpoint-config-08-01-04-21-10",
                     "endpoint_name":"demo-lambda-deploy-endpoint-08-01-04-21-10"
                  },
                  "FunctionArn":"arn:aws:lambda:us-east-1:368703438116:function:sagemaker-lambda-step-endpoint-deploy-08-01-04-21-10",
                  "OutputParameters":[
                     {
                        "OutputName":"statusCode",
                        "OutputType":"String"
                     },
                     {
                        "OutputName":"body",
                        "OutputType":"String"
                     },
                     {
                        "OutputName":"other_key",
                        "OutputType":"String"
                     }
                  ]
               },
               {
                  "Name":"AbaloneTransform",
                  "Type":"Transform",
                  "Arguments":{
                     "ModelName":{
                        "Get":"Steps.CreateBestModel-CreateModel.ModelName"
                     },
                     "TransformInput":{
                        "DataSource":{
                           "S3DataSource":{
                              "S3DataType":"S3Prefix",
                              "S3Uri":{
                                 "Get":"Parameters.BatchData"
                              }
                           }
                        }
                     },
                     "TransformOutput":{
                        "S3OutputPath":"s3://sagemaker-us-east-1-368703438116/tuning-step-example/AbaloneTransform"
                     },
                     "TransformResources":{
                        "InstanceCount":1,
                        "InstanceType":"ml.m5.xlarge"
                     }
                  }
               }
            ],
            "ElseSteps":[
               {
                  "Name":"AbaloneMSEFail",
                  "Type":"Fail",
                  "Arguments":{
                     "ErrorMessage":{
                        "Std:Join":{
                           "On":" ",
                           "Values":[
                              "Execution failed due to MSE >",
                              6.0
                           ]
                        }
                     }
                  }
               }
            ]
         }
      }
   ]
}